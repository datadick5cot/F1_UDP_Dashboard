<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rival Comparison Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-deep: #0a0a0a;
            --display-glass: rgba(20, 20, 20, 0.95);
            --f1-red: #e10600;
            --f1-green: #00ff00;
            --f1-amber: #FFBF00;
        }

        body {
            background-color: #111;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            font-family: 'Orbitron', sans-serif;
            color: white;
            overflow: hidden;
        }

        .container {
            display: flex;
            gap: 20px;
            width: 90%;
            max-width: 1200px;
        }

        .player-column, .rival-column {
            flex: 1;
            background: var(--display-glass);
            border-radius: 15px;
            padding: 20px;
            border: 2px solid #333;
            box-sizing: border-box;
            text-align: center;
            position: relative;
        }

        .player-column {
            background: rgba(0, 0, 150, 0.2); /* Semi-transparent blue */
            border-color: #0000FF; /* Blue border */
        }
        .player-column h2 {
            color: #0000FF; /* Blue text */
        }

        .rival-column {
            background: rgba(150, 0, 0, 0.2); /* Semi-transparent red */
            border-color: #FF0000; /* Red border */
        }
        .rival-column h2 {
            color: #FF0000; /* Red text */
        }

        h2 {
            text-transform: uppercase;
            font-size: 2em;
            margin-bottom: 20px;
            color: #eee;
        }

        .data-block {
            display: flex; /* Use flexbox */
            justify-content: space-between; /* Space out label and value */
            align-items: center; /* Vertically align items */
            margin-bottom: 8px; /* Reduce vertical spacing */
            border-bottom: 1px solid #333;
            padding-bottom: 8px; /* Reduce padding */
            padding-top: 5px; /* Add some top padding */
        }

        .label {
            color: #666;
            font-size: 0.9em;
            text-transform: uppercase;
            flex-shrink: 0; /* Prevent label from shrinking */
            margin-right: 10px; /* Space between label and value */
            text-align: left; /* Align label to left */
        }

        .value {
            font-size: 1.8em;
            font-weight: bold;
            font-family: monospace;
            color: white;
            text-align: right; /* Align value to right */
        }

        .comparison-value {
            font-size: 1.8em;
            font-weight: bold;
            font-family: monospace;
        }

        .gauge-container {
            width: 100%;
            height: 20px;
            background-color: #333;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 5px;
        }

        .gauge-fill {
            height: 100%;
            width: 0%;
            background-color: var(--f1-green);
            transition: width 0.1s ease-out;
        }
        
        .gauge-fill.throttle { background-color: #ff9800; } /* Orange */
        .gauge-fill.brake { background-color: #f44336; }    /* Red */
        .gauge-fill.steer { background-color: #2196f3; }    /* Blue */

        .green-text { color: var(--f1-green); }
        .red-text { color: var(--f1-red); }

    </style>
</head>
<body>
    <div class="container">
        <div class="player-column">
            <h2>Player</h2>
            <div class="data-block">
                <div class="label">Player Lap Time</div>
                <div class="value" id="player-lap-time">--:--.---</div>
            </div>
            <div class="data-block">
                <div class="label">S1 Time</div>
                <div class="value" id="player-s1-time">--.---</div>
            </div>
            <div class="data-block">
                <div class="label">S2 Time</div>
                <div class="value" id="player-s2-time">--.---</div>
            </div>
            <div class="data-block">
                <div class="label">S3 Time</div>
                <div class="value" id="player-s3-time">--.---</div>
            </div>

            <h3>Telemetry</h3>
            <div class="data-block">
                <div class="label">Throttle</div>
                <div class="gauge-container"><div class="gauge-fill throttle" id="player-throttle-gauge"></div></div>
                <div class="comparison-value" id="player-throttle-value">0%</div>
            </div>
            <div class="data-block">
                <div class="label">Brake</div>
                <div class="gauge-container"><div class="gauge-fill brake" id="player-brake-gauge"></div></div>
                <div class="comparison-value" id="player-brake-value">0%</div>
            </div>
            <div class="data-block">
                <div class="label">Steering</div>
                <div class="gauge-container"><div class="gauge-fill steer" id="player-steer-gauge"></div></div>
                <div class="comparison-value" id="player-steer-value">0</div>
            </div>
            <div class="data-block">
                <div class="label">Gear</div>
                <div class="value" id="player-gear">N</div>
            </div>
        </div>

        <div class="rival-column">
            <h2>Rival</h2>
            <div class="data-block">
                <div class="label">Rival Lap Time</div>
                <div class="value" id="rival-lap-time">--:--.---</div>
            </div>
            <div class="data-block">
                <div class="label">S1 Time</div>
                <div class="value" id="rival-s1-time">--.---</div>
            </div>
            <div class="data-block">
                <div class="label">S2 Time</div>
                <div class="value" id="rival-s2-time">--.---</div>
            </div>
            <div class="data-block">
                <div class="label">S3 Time</div>
                <div class="value" id="rival-s3-time">--.---</div>
            </div>

            <h3>Telemetry</h3>
            <div class="data-block">
                <div class="label">Throttle</div>
                <div class="gauge-container"><div class="gauge-fill throttle" id="rival-throttle-gauge"></div></div>
                <div class="comparison-value" id="rival-throttle-value">0%</div>
            </div>
            <div class="data-block">
                <div class="label">Brake</div>
                <div class="gauge-container"><div class="gauge-fill brake" id="rival-brake-gauge"></div></div>
                <div class="comparison-value" id="rival-brake-value">0%</div>
            </div>
            <div class="data-block">
                <div class="label">Steering</div>
                <div class="gauge-container"><div class="gauge-fill steer" id="rival-steer-gauge"></div></div>
                <div class="comparison-value" id="rival-steer-value">0</div>
            </div>
            <div class="data-block">
                <div class="label">Gear</div>
                <div class="value" id="rival-gear">N</div>
            </div>
        </div>
    </div>

    <script>
        let telemetryState = {};

        // Player elements
        const playerLapTimeEl = document.getElementById('player-lap-time');
        const playerS1TimeEl = document.getElementById('player-s1-time');
        const playerS2TimeEl = document.getElementById('player-s2-time');
        const playerS3TimeEl = document.getElementById('player-s3-time');
        const playerThrottleGauge = document.getElementById('player-throttle-gauge');
        const playerThrottleValue = document.getElementById('player-throttle-value');
        const playerBrakeGauge = document.getElementById('player-brake-gauge');
        const playerBrakeValue = document.getElementById('player-brake-value');
        const playerSteerGauge = document.getElementById('player-steer-gauge');
        const playerSteerValue = document.getElementById('player-steer-value');
        const playerGearEl = document.getElementById('player-gear');


        // Rival elements
        const rivalLapTimeEl = document.getElementById('rival-lap-time');
        const rivalS1TimeEl = document.getElementById('rival-s1-time');
        const rivalS2TimeEl = document.getElementById('rival-s2-time');
        const rivalS3TimeEl = document.getElementById('rival-s3-time');
        const rivalThrottleGauge = document.getElementById('rival-throttle-gauge');
        const rivalThrottleValue = document.getElementById('rival-throttle-value');
        const rivalBrakeGauge = document.getElementById('rival-brake-gauge');
        const rivalBrakeValue = document.getElementById('rival-brake-value');
        const rivalSteerGauge = document.getElementById('rival-steer-gauge');
        const rivalSteerValue = document.getElementById('rival-steer-value');
        const rivalGearEl = document.getElementById('rival-gear');

        const gearMap = {
            '-1': 'R',
            '0': 'N',
            '1': '1',
            '2': '2',
            '3': '3',
            '4': '4',
            '5': '5',
            '6': '6',
            '7': '7',
            '8': '8'
        };


        async function fetchTelemetry() {
            try {
                const res = await fetch("http://localhost:8000/telemetry");
                telemetryState = await res.json();
            } catch (err) {
                console.error("Failed to fetch telemetry:", err);
            }
        }

        function formatTime(ms) {
            if (ms === 0 || ms === undefined || ms === null) return '--:--.---';
            const minutes = Math.floor(ms / 60000);
            const seconds = Math.floor((ms % 60000) / 1000);
            const milliseconds = ms % 1000;
            return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}.${String(milliseconds).padStart(3, '0')}`;
        }

        function formatSectorTime(ms) {
            if (ms === 0 || ms === undefined || ms === null) return '--.---';
            const seconds = Math.floor(ms / 1000);
            const milliseconds = ms % 1000;
            return `${String(seconds).padStart(2, '0')}.${String(milliseconds).padStart(3, '0')}`;
        }
        
        function updateGauge(gaugeEl, valueEl, value, isSteer = false) {
            if (value === undefined || value === null) return;
            let percentage;
            let displayValue;

            if (isSteer) {
                // Steer value is -1.0 to 1.0, map to 0-100% for gauge, display as is
                percentage = (value + 1) * 50; // Map -1 to 0%, 0 to 50%, 1 to 100%
                displayValue = value.toFixed(2);
            } else {
                // Throttle/Brake are 0.0 to 1.0, map to 0-100%
                percentage = value * 100;
                displayValue = `${(value * 100).toFixed(0)}%`;
            }
            gaugeEl.style.width = `${percentage}%`;
            valueEl.innerText = displayValue;
        }


        function updateDashboard() {
            if (!telemetryState || Object.keys(telemetryState).length === 0) return;

            // Player Lap Data (from m_playerSessionBestDataSet)
            if (telemetryState.m_playerSessionBestDataSet) {
                const playerBest = telemetryState.m_playerSessionBestDataSet;
                playerLapTimeEl.innerText = formatTime(playerBest.m_lapTimeInMS);
                playerS1TimeEl.innerText = formatSectorTime(playerBest.m_sector1TimeInMS);
                playerS2TimeEl.innerText = formatSectorTime(playerBest.m_sector2TimeInMS);
                playerS3TimeEl.innerText = formatSectorTime(playerBest.m_sector3TimeInMS);
            }

            // Rival Lap Data (from m_rivalDataSet)
            if (telemetryState.m_rivalDataSet) {
                const rivalBest = telemetryState.m_rivalDataSet;
                rivalLapTimeEl.innerText = formatTime(rivalBest.m_lapTimeInMS);
                rivalS1TimeEl.innerText = formatSectorTime(rivalBest.m_sector1TimeInMS);
                rivalS2TimeEl.innerText = formatSectorTime(rivalBest.m_sector2TimeInMS);
                rivalS3TimeEl.innerText = formatSectorTime(rivalBest.m_sector3TimeInMS);
            }

            // Player Telemetry
            if (telemetryState.player_telemetry) {
                const pt = telemetryState.player_telemetry;
                updateGauge(playerThrottleGauge, playerThrottleValue, pt.m_throttle);
                updateGauge(playerBrakeGauge, playerBrakeValue, pt.m_brake);
                updateGauge(playerSteerGauge, playerSteerValue, pt.m_steer, true);
                if (pt.m_gear !== undefined) {
                    playerGearEl.innerText = gearMap[pt.m_gear] || pt.m_gear;
                }
            }

            // Rival Telemetry
            if (telemetryState.rival_telemetry) {
                const rt = telemetryState.rival_telemetry;
                updateGauge(rivalThrottleGauge, rivalThrottleValue, rt.m_throttle);
                updateGauge(rivalBrakeGauge, rivalBrakeValue, rt.m_brake);
                updateGauge(rivalSteerGauge, rivalSteerValue, rt.m_steer, true);
                if (rt.m_gear !== undefined) {
                    rivalGearEl.innerText = gearMap[rt.m_gear] || rt.m_gear;
                }
            }
        }

        setInterval(async () => {
            await fetchTelemetry();
            updateDashboard();
        }, 100);

    </script>
</body>
</html>